<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PopLinkBadge</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      color: #333;
    }

    .container {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #5a5a5a;
      text-align: center;
    }

    input[type="file"] {
      border: 1px solid #ddd;
      padding: 10px;
      width: calc(100% - 22px);
      border-radius: 4px;
    }

    input[type="submit"] {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      margin-top: 10px;
    }

    input[type="submit"]:hover {
      background-color: #0056b3;
    }

    .note {
      font-size: 0.9em;
      color: #666;
      margin-top: 15px;
    }

    #status-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }

    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-info {
      background-color: #cce5ff;
      color: #004085;
      border: 1px solid #b8daff;
    }

    /* Tab Styles */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .tab-link {
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-bottom: none;
      color: #333;
      padding: 10px 15px;
      cursor: pointer;
      margin-right: 2px;
      border-radius: 4px 4px 0 0;
      flex: 1;
      text-align: center;
      font-size: 14px;
    }

    .tab-link.active {
      background-color: #fff;
      border-bottom: 1px solid #fff;
      font-weight: bold;
      color: #007bff;
      margin-bottom: -1px;
    }

    .tab-content {
      display: none;
      padding: 15px 0;
      animation: fadeEffect 0.5s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeEffect {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>PopLinkBadge</h1>
    <p style="text-align: center; color: #666; margin-bottom: 20px;">
      最大5枚の画像を登録できます。<br>
      登録された画像は自動的に切り替わります。
    </p>
    <div class="tabs" id="tabs-container"></div>
    <div id="slots-container"></div>
    <div id="status-message"></div>

    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
      <h3 style="margin-top: 0; color: #5a5a5a;">スライド間隔設定</h3>
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <input type="range" id="interval-slider" min="1000" max="10000" step="100" value="3000"
          style="flex-grow: 1; margin-right: 15px;">
        <span id="interval-value" style="font-weight: bold; width: 60px; text-align: right;">3.0秒</span>
      </div>
      <div style="text-align: center; margin-top: 15px;">
        <button id="start-slideshow-btn"
          style="background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px;">スライドショー開始</button>
      </div>
    </div>

    <div class="note">
      <p>
        PNGまたはJPG画像をアップロードしてください。<br>
        画像は240x240ピクセルにリサイズされます。<br>
        画像アップロード後、自動的にスライドショーに反映されます。
      </p>
    </div>
  </div>

  <script>
    const tabsContainer = document.getElementById('tabs-container');
    const slotsContainer = document.getElementById('slots-container');
    const statusMessage = document.getElementById('status-message');
    const MAX_SLOTS = 5;

    // スロット生成
    for (let i = 0; i < MAX_SLOTS; i++) {
      // タブボタン生成
      const tabBtn = document.createElement('div');
      tabBtn.className = 'tab-link';
      tabBtn.innerText = `Slot ${i + 1}`;
      tabBtn.onclick = () => openTab(i);
      tabsContainer.appendChild(tabBtn);

      // タブコンテンツ生成
      const slotDiv = document.createElement('div');
      slotDiv.className = 'tab-content';
      slotDiv.id = `slot-${i}`;

      const form = document.createElement('form');
      form.id = `upload-form-${i}`;
      form.action = `/upload?id=${i}`;
      form.method = 'post';
      form.enctype = 'multipart/form-data';

      const input = document.createElement('input');
      input.type = 'file';
      input.id = `image-input-${i}`;
      input.name = 'image';
      input.accept = 'image/png, image/jpeg, image/jpg';

      const deleteBtn = document.createElement('button');
      deleteBtn.innerText = '削除';
      deleteBtn.style.backgroundColor = '#dc3545';
      deleteBtn.style.color = 'white';
      deleteBtn.style.border = 'none';
      deleteBtn.style.padding = '5px 10px';
      deleteBtn.style.borderRadius = '4px';
      deleteBtn.style.marginLeft = '10px';
      deleteBtn.style.cursor = 'pointer';

      // クロージャの問題を避けるために関数呼び出し時にiを渡す
      // (let i なのでループごとのスコープが作られるため、このままでもOKだが、明示的に)

      const submit = document.createElement('input');
      submit.type = 'submit';
      submit.value = 'Upload';
      submit.style.width = 'auto';

      const btnContainer = document.createElement('div');
      btnContainer.style.marginTop = '10px';
      btnContainer.appendChild(submit);
      btnContainer.appendChild(deleteBtn);

      const previewContainer = document.createElement('div');
      previewContainer.id = `preview-container-${i}`;
      previewContainer.style.marginTop = '10px';
      previewContainer.style.textAlign = 'center';

      // 画像プレビュー
      const img = document.createElement('img');
      img.id = `thumbnail-${i}`;
      img.alt = `Slot ${i + 1} Preview`;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '240px';
      img.style.border = '1px solid #ddd';
      img.style.borderRadius = '4px';

      // 初期状態は非表示、ロード成功で表示
      img.style.display = 'none';
      img.onload = () => { img.style.display = 'block'; };
      img.onerror = () => { img.style.display = 'none'; };

      img.src = `image${i}.png?t=${new Date().getTime()}`;

      previewContainer.appendChild(img);

      form.appendChild(input);
      form.appendChild(btnContainer);
      slotDiv.appendChild(form);
      slotDiv.appendChild(previewContainer);
      slotsContainer.appendChild(slotDiv);

      // イベントリスナー登録
      deleteBtn.addEventListener('click', (event) => handleDelete(event, i, input, img, form));

      input.addEventListener('change', () => {
        const file = input.files[0];
        if (file) {
          img.src = URL.createObjectURL(file);
          img.style.display = 'block';
        }
      });

      form.addEventListener('submit', (event) => handleUpload(event, i, input, form));
    }

    // 最初のタブをアクティブにする
    openTab(0);

    function openTab(slotIndex) {
      const tabLinks = document.getElementsByClassName("tab-link");
      const tabContents = document.getElementsByClassName("tab-content");

      for (let i = 0; i < tabLinks.length; i++) {
        tabLinks[i].classList.remove("active");
        tabContents[i].classList.remove("active");
      }

      tabLinks[slotIndex].classList.add("active");
      tabContents[slotIndex].classList.add("active");
      statusMessage.style.display = 'none'; // タブ切り替え時にメッセージを消す
    }

    function handleDelete(event, slotId, input, img, form) {
      event.preventDefault();
      if (!confirm(`Slot ${slotId + 1} の画像を削除しますか？`)) {
        return;
      }

      showStatus(`Slot ${slotId + 1} 削除中...`, 'info');

      fetch(`/delete?id=${slotId}`, {
        method: 'POST'
      })
        .then(response => {
          if (!response.ok) throw new Error('削除失敗: ' + response.status);
          return response.text();
        })
        .then(result => {
          showStatus(`Slot ${slotId + 1} 削除完了`, 'success');
          form.reset();
          img.removeAttribute('src');
          img.style.display = 'none';
          setTimeout(() => {
            statusMessage.style.display = 'none';
          }, 3000);
        })
        .catch(error => {
          showStatus('エラー: ' + error.message, 'error');
        });
    }

    function handleUpload(event, slotId, input, form) {
      event.preventDefault();
      const file = input.files[0];

      if (!file) {
        showStatus('ファイルを選択してください。', 'error');
        return;
      }

      showStatus(`Slot ${slotId + 1} 画像処理中...`, 'info');

      resizeImage(file, 240, 240)
        .then(blob => {
          showStatus(`Slot ${slotId + 1} アップロード中...`, 'info');
          const formData = new FormData();
          formData.append('image', blob, file.name.replace(/\.[^/.]+$/, "") + ".png");
          return fetch(`/upload?id=${slotId}`, {
            method: 'POST',
            body: formData
          });
        })
        .then(response => {
          if (!response.ok) throw new Error('サーバーエラー ' + response.status);
          return response.text();
        })
        .then(result => {
          showStatus(`Slot ${slotId + 1} アップロード完了`, 'success');
          form.reset();
          setTimeout(() => {
            statusMessage.style.display = 'none';
          }, 3000);
        })
        .catch(error => {
          showStatus('処理失敗: ' + error.message, 'error');
        });
    }

    function resizeImage(file, maxWidth, maxHeight) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
          const width = img.width;
          const height = img.height;

          // アスペクト比を維持して、ターゲットサイズを完全に埋めるようにスケーリング (Cover / Center Crop)
          const ratio = Math.max(maxWidth / width, maxHeight / height);

          const newWidth = width * ratio;
          const newHeight = height * ratio;

          // 中央に描画するためのオフセット計算
          const offsetX = (maxWidth - newWidth) / 2;
          const offsetY = (maxHeight - newHeight) / 2;

          const canvas = document.createElement('canvas');
          canvas.width = maxWidth;
          canvas.height = maxHeight;
          const ctx = canvas.getContext('2d');

          // 背景は黒（画像が全体を覆うので基本見えないが念のため）
          ctx.fillStyle = '#000000';
          ctx.fillRect(0, 0, maxWidth, maxHeight);

          // 画像を描画（はみ出し部分は自動的にクロップされる）
          ctx.drawImage(img, offsetX, offsetY, newWidth, newHeight);

          canvas.toBlob((blob) => {
            if (blob) {
              resolve(blob);
            } else {
              reject(new Error('CanvasからBlobへの変換に失敗しました。'));
            }
          }, 'image/png');
        };
        img.onerror = (error) => {
          reject(new Error('画像の読み込みに失敗しました。'));
        };
      });
    }

    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = '';
      statusMessage.classList.add('status-' + type);
      statusMessage.style.display = 'block';
    }

    // スライド時間設定
    const intervalSlider = document.getElementById('interval-slider');
    const intervalValue = document.getElementById('interval-value');

    // 初期値取得
    fetch('/get-interval')
      .then(response => {
        if (response.ok) return response.text();
        throw new Error('Get interval failed');
      })
      .then(text => {
        const val = parseInt(text);
        if (!isNaN(val)) {
          intervalSlider.value = val;
          intervalValue.innerText = (val / 1000).toFixed(1) + '秒';
        }
      })
      .catch(console.error);

    // 値変更イベント (表示更新)
    intervalSlider.addEventListener('input', () => {
      const val = intervalSlider.value;
      intervalValue.innerText = (val / 1000).toFixed(1) + '秒';
    });

    // 値変更確定イベント (送信)
    intervalSlider.addEventListener('change', () => {
      const val = intervalSlider.value;
      const params = new URLSearchParams();
      params.append('value', val);

      fetch('/set-interval', {
        method: 'POST',
        body: params
      }).then(res => {
        if (res.ok) showStatus('設定を保存しました', 'success');
        else showStatus('設定保存に失敗しました', 'error');
        setTimeout(() => { statusMessage.style.display = 'none'; }, 2000);
      });
    });

    // スライドショー開始ボタン
    document.getElementById('start-slideshow-btn').addEventListener('click', () => {
      showStatus('スライドショーを開始します...', 'info');
      fetch('/start-slideshow', { method: 'POST' })
        .then(res => {
          if (res.ok) {
            showStatus('スライドショーを開始しました', 'success');
            setTimeout(() => { statusMessage.style.display = 'none'; }, 2000);
          } else {
            showStatus('開始に失敗しました', 'error');
          }
        })
        .catch(err => showStatus('通信エラー', 'error'));
    });
  </script>

</body>

</html>